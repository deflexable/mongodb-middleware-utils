"use strict";var e=require("mongodb"),t=require("mongodb/lib/bson"),n=require("worker_threads"),r=require("url"),i=require("path"),a=require("./worker-BwM7ibXw.js"),o="undefined"!=typeof document?document.currentScript:null;const s="undefined"!=typeof __dirname?__dirname:i.dirname(r.fileURLToPath("undefined"==typeof document?require("url").pathToFileURL(__filename).href:o&&"SCRIPT"===o.tagName.toUpperCase()&&o.src||new URL("index.js",document.baseURI).href)),l="__fta_",c="__rdz";class f extends e.MongoClient{constructor({map:e,url:t,tokenizer:n,options:r}){super(t,r),this.interceptMap={map:e,tokenizer:n},u(super.db.bind(this),this.interceptMap)}get db(){return d(super.db.bind(this),this.interceptMap)}__intercepted=!0}const u=(e,t)=>{const{map:n,tokenizer:r,indexNotice:i}=t;if(void 0!==r&&"function"!=typeof r)throw`expected a function for field:"tokenizer" but got ${r}`;if(void 0!==i&&!["warn","error","off"].some((e=>i===e)))throw`expected either a function or any of 'warn', 'error', 'off' for field:"indexNotice" but got ${i}`;Object.entries(n).forEach((([t,n])=>{Object.entries(n).forEach((([n,i])=>{const o=`dbName(${t}), collectionName(${n})`,{fulltext:s,random:f,safeOverhead:u,overhead:d}=i||{};if(s)if(Array.isArray(s)){if(s.filter((e=>"string"!=typeof e||e.includes(".")||!e.trim())).length)throw`invalid interception value in ${o}, fulltext array must contain a non empty string without "." value but got ${JSON.stringify(s)}`;if(!s.length)throw`invalid interception value in ${o}, fulltext array must not be empty`;if(s.filter(((e,t,n)=>n.indexOf(e)===t)).length!==s.length)throw`invalid interception value in ${o}, fulltext array must not contain duplicate value but got ${s}`}else{if("string"!=typeof s||s.includes("."))throw`invalid interception value in ${o}, fulltext must either be a string without "." or array but got ${s}`;if(!s.trim())throw`invalid interception value in ${o}, fulltext must not be empty`}if(void 0!==f&&"boolean"!=typeof f)throw`invalid interception value in ${o}, random should be a boolean value but got ${i}`;if(u&&!d)throw'"safeOverhead" should only be true when "overhead" is true';if(d&&!a.Scope.listeningFulltext[o]&&(s||f)){a.Scope.listeningFulltext[o]=!0;const i=e(t).collection(n),d=i.watch(),p=s?Array.isArray(s)?s:[s]:[];console.log("listening overhead:",n),d.on("change",(async({operationType:e,fullDocument:t,updateDescription:n,documentKey:a})=>{if("delete"===e)return;const{_id:o}=a,d=t||await i.findOne({_id:o});if(!d)return;const m=s?"insert"===e?p.filter((e=>!d[`${l}${e}`])):Object.keys(n?.updatedFields||{}).filter((e=>p.includes(e))):[];if(m.length||f&&!d[c])if(console.log("overhead working"),u){const e=15728640-JSON.stringify({...d,...Object.fromEntries(m.map((e=>[e])))}).length;if(e>0){const t=await Promise.all(m.map((async e=>{const t=d[e],n="string"==typeof t&&await(r?.(t));return[e,await b(r?n:t)]}))),n=t.map((([e])=>[e,new Set([])]));let a,s=0;for(let r=0;r<t.length&&!a;r++)for(let i=0;i<t[r][1].length;i++){const o=t[r][1][i];if((a=s+=o.length+4)>=e)break;n[r][1].add(o)}i.updateOne({_id:o},{$set:{...Object.fromEntries(n.map((([e,t])=>[`${l}${e}`,[...t]])).filter((e=>e[1].length))),...d[c]?{}:{[c]:Math.random()}}})}else d[c]||i.updateOne({_id:o},{$set:{[c]:Math.random()}})}else{const e=await Promise.all(m.map((async e=>{const t=d[e],n="string"==typeof t&&await(r?.(t));return[`${l}${e}`,await b(r?n:t)]})));i.updateOne({_id:o},{$set:{...Object.fromEntries(e),...d[c]?{}:{[c]:Math.random()}}})}}))}}))}))},d=(e,t)=>function(){const{map:n,tokenizer:r,indexNotice:i}=t,a=e(...arguments),[o]=[...arguments];let s=function(){const e=[...arguments],t=a.collection(...e),s={},f=e[0];return Object.entries(n).forEach((([e,n])=>{Object.entries(n).forEach((([n,a])=>{const u={...a,tokenizer:r};if(o===e&&f===n&&(u?.fulltext||u?.random)){const{fulltext:e,random:n}=u,r=t=>{if(t?.$text?.$search&&e){const n=t.$text.$field||e,r=Array.isArray(n)?n:[n];if(r.filter(((e,t,n)=>n.indexOf(e)===t)).length!==r.length)throw"$field must not contain duplicate values";delete(t={...t,$or:[...t?.$or||[],...r.map((e=>({[`${l}${e}`]:{$in:[h(t?.$text?.$search)]}})))]}).$text}return t},a=e=>{const t=(Array.isArray(e)?e:[e]).map((e=>{if(!e)return e;const t={...e};return Object.keys(e).forEach((e=>{(e.startsWith(l)||e===c)&&delete t[e]})),t}));return Array.isArray(e)?t:t[0]},o=async t=>(w(t)&&((t={...t}).$set&&(t.$set=await g(t.$set,u)),t.$setOnInsert&&(t.$setOnInsert=await g(t.$setOnInsert,u)),t.$unset&&(Array.isArray(e)?e:[e]).forEach((e=>{t.$unset[e]&&(t.$unset[`${l}${e}`]=!0)}))),t);s.insertOne=async function(){return await t.insertOne(await g([...arguments][0],u),[...arguments][1])},s.insertMany=async function(){return await t.insertMany(await Promise.all([...arguments][0].map((e=>g(e,u)))),[...arguments][1])},["updateOne","updateMany"].forEach((e=>{s[e]=async function(){const n=[...arguments],a=r(n[0]);return await p(t.find(a).limit(1),i),await t[e](a,await o(n[1]),n[2])}})),s.replaceOne=async function(){const e=[...arguments],n=r(e[0]);return await p(t.find(n).limit(1),i),await t.replaceOne(n,await g(e[1],u),e[2])},s.bulkWrite=async function(){let[e,...n]=[...arguments];return await t.bulkWrite(await Promise.all(e.map((async e=>{const n={};return await Promise.all(Object.entries(e).map((async([e,a])=>{"insertOne"!==e&&await p(t.find(a.filter).limit(1),i),n[e]={...a,...a.filter?{filter:r(a.filter)}:{},...a.arrayFilters?{}:{arrayFilters:a.arrayFilters.map(r)},...a.document?{document:await g(a.document,u)}:{},...a.replacement?{replacement:await g(a.replacement,u)}:{},...a.update?{update:await o(a.update)}:{}}}))),n}))),...n)},s.find=function(){let[e,...n]=[...arguments];const o=r(e),s=t.find(o,...n),l=s.toArray.bind(s),c=s.limit.bind(s);return s.toArray=async()=>(await p(c(1),i),a(await l())),s},s.findOne=async function(){let[e,...n]=[...arguments];const o=r(e);await p(t.find(o).limit(1),i);const s=await t.findOne(o,...n);return a(s)},s.watch=function(){const[e,...n]=[...arguments],i=t.watch(Array.isArray(e)?e.map(r):r(e),...n),o={},s={};return["on","once","prependListener","addListener","prependOnceListener"].forEach((e=>{o[e]=(t,n)=>{if("change"===t){const t=`${Math.random()}`;return s[t]=e=>{const t=e;t.fullDocument&&(t.fullDocument=a(t.fullDocument)),t.fullDocumentBeforeChange&&(t.fullDocumentBeforeChange=a(t.fullDocumentBeforeChange)),t.updateDescription?.updatedFields&&(t.updateDescription.updatedFields=a(t.updateDescription.updatedFields)),n?.(t)},n.prototype||(n.prototype={}),n.prototype.__cloneMongodbListener||(n.prototype.__cloneMongodbListener=[]),n.prototype.__cloneMongodbListener.push(t),i[e]("change",s[t])}return i[e](t,n)}})),["off","removeListener"].forEach((e=>{o[e]=(t,n)=>{if("change"===t){const r=n.prototype?.__cloneMongodbListener;r&&(r.forEach((n=>{i[e](t,s[n]),s[n]&&delete s[n]})),delete n.prototype.__cloneMongodbListener)}else i[e](t,e)}})),new Proxy({},{get:(e,t)=>o[t]?o[t]:"function"==typeof i[t]?i[t].bind(i):i[t],set:(e,t,n)=>(o[t]?o[t]=n:i[t]=n,!0)})},s.aggregate=function(){const[e,o]=[...arguments],[s,l]=e,f=s?.$sample?.size,u=r(l?.$match),d=Number.isInteger(f)&&f>0&&n,h=t.aggregate(e.map((e=>e?.$match?{...e,$match:r(e.$match)}:e)),o),g=h.toArray.bind(h);h.toArray=async()=>a(await g());let w=async()=>{const[[e,n]]=await Promise.all([Promise.all(["asc","desc"].map((e=>t.find({...u},o).sort(c,e).limit(1).toArray()))),Promise.all(["asc","desc"].map((e=>p(t.find(u).sort(c,e).limit(1),i))))]),[r,s]=[e[0]?.[c],n[0]?.[c]].map((e=>e&&1*e));if(isNaN(r)||isNaN(s))return[];if(r===s)return a(e);{const e=f+0,n=(s-r)/e,i=[];let l=r;Array(e).fill().forEach((()=>{i.push(y(l+=n,l))}));const d=await Promise.all(i.map((e=>t.find({...u,[c]:{$gte:e}},o).sort(c,"asc").limit(3).toArray()))),p=m(d.flat().filter(((e,t,n)=>n.findIndex((t=>_.equal(t._id,e._id)))===t)));if(p.length>=f)return a(p.slice(0,f));{const e=await Promise.all(["asc","desc"].map((e=>t.find({...u},o).sort(c,e).limit(Math.ceil(f/2)).toArray()))),n=[...p,...m(e.flat().filter(((e,t,n)=>n.findIndex((t=>_.equal(t._id,e._id)))===t)))].filter(((e,t,n)=>n.findIndex((t=>_.equal(t._id,e._id)))===t));return a(n.slice(0,f))}}};return new Proxy({},{get:(e,t)=>"toArray"===t&&d?w:"function"==typeof h[t]?h[t].bind(h):h[t],set:(e,t,n)=>("toArray"===t&&d?w=n:h[t]=n,!0)})}}}))})),new Proxy({},{get:(e,n)=>s[n]?s[n]:"function"==typeof t[n]?t[n].bind(t):t[n],set:(e,n,r)=>(s[n]?s[n]=r:t[n]=r,!0)})};return new Proxy({},{get:(e,t)=>"collection"===t?s:"function"==typeof a[t]?a[t].bind(a):a[t],set:(e,t,n)=>("collection"===t?s=n:a[t]=n,!0)})},p=async(e,t)=>{if("off"===t||!t)return;const n=await e.explain("queryPlanner"),{stage:r,indexName:i,inputStage:a}={...n?.queryPlanner?.winningPlan?.inputStage},{stage:o,indexName:s}={...a};if(!("IXSCAN"===r&&i||"IXSCAN"===o&&s)){if("function"==typeof t)return void t(n?.command);const e="cannot perform an index scan for mongodb query with command:";if("error"===t)throw`${e} ${JSON.stringify(n?.command)}`;console.warn(e,n?.command)}},m=e=>{const t=[...e];let n,r=t.length;for(;0!=r;)n=Math.floor(Math.random()*r),r--,[t[r],t[n]]=[t[n],t[r]];return t},y=(e=70,t=0)=>(e-t)*Math.random()+t,h=e=>a.transformPunctuation(e.trim()),g=async(e,{fulltext:t,random:n,overhead:r,tokenizer:i})=>{if(r)return e;if(!w(e))return e;const a={...e};return t&&(t=Array.isArray(t)?t:[t],await Promise.all(t.map((async t=>{const n=e[t];if("string"==typeof n&&n.trim()&&!e[`${l}${t}`]){const e="string"==typeof n&&await(i?.(n));a[`${l}${t}`]=await b(i?e:n)}})))),n&&!e[c]&&(a[c]=Math.random()),a},w=e=>null!==e&&"object"==typeof e&&!Array.isArray(e),b=async e=>{if(!e?.trim?.())return[];const t=O(e),n=t.length>1?await Promise.all(t.map((e=>$(`${s}/worker.js`,{text:e})))):t.map((e=>({indexes:a.generateFulltextIndex(e)})));return[...new Set(n.map((e=>e.indexes)).flat())]},$=(e,t)=>new Promise((r=>{const i=new n.Worker(e);i.on("message",(e=>{r(e),i.terminate()})),i.postMessage(t)})),x=2e4,O=(e="")=>{e=e.split(" ");let t=[[]],n=0,r=0;for(let i=0;i<e.length;i++){const a=e[i];r+=a.length,++n<=2700&&r<x||!t[t.length-1].length?t[t.length-1].push(a):(t.push([a]),r=a.length,n=1)}const i=[];return t.forEach((e=>{e.length&&(e[0].length>x?Array(Math.ceil(e[0].length/x)).fill().forEach(((t,n)=>{i.push(e[0].substring(n*x,(n+1)*x))})):i.push(e.join(" ")))})),i},_={equal:(e,t,n)=>(e=v(e),t=v(t),M(t)||M(e)?A(e,t)&&JSON.stringify(e)===JSON.stringify(t):t instanceof RegExp?A(e,t)?e.source===t.source&&e.flags===t.flags:n&&"string"==typeof e&&t.test(e):JSON.stringify(e)===JSON.stringify(t))},A=(e,t)=>{try{return e.constructor===t.constructor&&Object.getPrototypeOf(e)===Object.getPrototypeOf(t)}catch(e){return!1}},v=e=>e instanceof t.BSONRegExp?new RegExp(e.pattern,e.options):[t.Long,t.Double,t.Int32,t.Decimal128].some((t=>e instanceof t))?1*e:e,M=e=>[t.Code,t.ObjectId,t.Binary,t.MaxKey,t.MinKey,t.UUID,t.Timestamp,t.BSONSymbol].some((t=>e instanceof t));exports.FULLTEXT_ARRAY_PREFIX=l,exports.MongoClientHack=f,exports.RANDOMIZER_FIELD=c,exports.getFulltextArray=b,exports.proxyClient=e=>t=>{if(t.__intercepted)throw"this MongoClient instance was previously intercepted";u(t.db.bind(t),e);const n=t.db.bind(t);t.db=d(n,e),t.__intercepted=!0};
